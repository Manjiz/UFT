<!DOCTYPE html>
<html ng-app="myapp">
<head>
<meta charset="utf-8" />
<title>JDC需求提报平台</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<link rel="icon" href="public/img/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="public/img/favicon.ico" type="image/x-icon" />

<link rel="stylesheet" href="public/css/normalize.css" />
<link rel="stylesheet" href="public/css/common.css" />
    <link rel="stylesheet" href="public/css/kendo/kendo.common-material.min.css">
    <link rel="stylesheet" href="public/css/kendo/kendo.rtl.min.css">
    <link rel="stylesheet" href="public/css/kendo/kendo.material.min.css">
    <link rel="stylesheet" href="public/css/kendo/kendo.material.mobile.min.css">
<link rel="stylesheet" href="public/js/lib/image-cropper/cropper.css" /><!--图片裁切-->
</head>
<body ng-controller="customersCtrl">

<div class="pse_wrap">
    <!--# S 引入头部 -->
    <div ng-include src="'view/core/header.html'"></div> 
    <!--# E 引入头部 -->
    
    <!--# S UI-VIEW -->
    <div ui-view style="padding-bottom:30px;overflow:hidden;"> </div>
    <!--# E UI-VIEW -->
    
</div>

<!--# S 引导 -->
<div class="mod_guid">
    <a class="mod_guid_backtop" href="javascript:void(0)">回顶部</a>
    <div class="mod_guid_qrcode">
        <a class="mod_guid_qrcode_thumb" href="/app#qrcode"><span></span></a>
        <img class="mod_guid_qrcode_pic" alt="UFT 前端需求提交平台" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkAQMAAABKLAcXAAAABlBMVEXr6+thkOgRGyM+AAABCUlEQVQ4y53TsZHEIAwF0D9DoHAb0KzaIKOlDZ2ZjPBackYbeGiCgPE/fAXAeX/EC/6gQML/Y2S0COmBnEvhEiOP4iEL7TVWVnbPvBZGvpFKJdYak7kG3z1kLiOTbjVrIOcakdE8dDyeia2mgh7gF3p1YNOg/uRc+nGNTe+OLLRjs1apKGEuRzaLZMFbngi77tbcAX/mufRljWRTKTKXY5faiu9y+bmMNbLx/kOeSIGdyehYFsLHosUegDMv9NKNrEfHhbnsxyUXuycvP9eIWOPonfmJjEwd95YXmevvHhJkTOYX2msqUkCWsFTsACxbeyqjyy4bF4KLTK5peIe5jIzWSrDj8lN9m18EH/zMN3SZnQAAAABJRU5ErkJggg==">
        <p class="mod_guid_qrcode_txt">扫扫访问 UFT</p>
    </div>
</div>
<!--# E 引导 -->

<!--# S 引入尾部 -->
<div ng-include src="'view/core/footer.html'"></div> 
<!--# E 引入尾部 -->

<script id="tpl" type="text/x-template">
<img src="dummy.png" title="{{title}}"/>
</script>

<!--<script src="http://weinre.qiang.it/target/target-script-min.js#taizhen"></script> 微信debug -->
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=53467417" charset="UTF-8"></script><!-- 页面统计 -->

<script src="public/js/lib/jquery-1.10.2.js"></script>
<script src="public/js/lib/angular.min.js"></script>
<script src="public/js/lib/plugins/angular-ui-router.js"></script><!--NG 路由插件-->
<script src="public/js/lib/md5.js"></script>
<!-- kendo customly build - autocomplete dropdownlist datepicker slider draganddrop || upload angular   [kendo-mobile-switch] -->
<script src="public/js/lib/plugins/kendo.custom.min.js"></script>
<script src="public/js/lib/plugins/kendo.upload.min.js"></script>
<script src="public/js/lib/plugins/kendo.angular.min.js"></script>
<!-- <script src="http://kendo.cdn.telerik.com/2015.3.1111/js/kendo.all.min.js"></script> -->
<script src="public/js/lib/plugins/ui-bootstrap-tpls-0.13.4.min.js"></script><!--NGUIBT 翻页插件-->
<script type="text/javascript" src="public/js/lib/pagedown/Markdown.Converter.js"></script><!-- pagedown 编辑器 -->
<script type="text/javascript" src="public/js/lib/pagedown/Markdown.Sanitizer.js"></script><!-- pagedown 编辑器 -->
<script type="text/javascript" src="public/js/lib/pagedown/Markdown.Editor.js"></script><!-- pagedown 编辑器 -->
<script src="public/js/lib/image-cropper/cropper.js"></script><!-- 图片裁切 -->
<script src="public/js/lib/ua-parser.min.js"></script>
<script src="public/js/common.js"></script>
<!-- STATE -->
<script src="state/stateLogin.js"></script>
<script src="state/stateApply.js"></script>
<script src="state/stateMyapply.js"></script>
<script src="state/stateGallery.js"></script>
<script src="state/stateSchedule.js"></script>
<script src="state/stateAudited.js"></script>
<script src="state/stateDetail.js"></script>
<script src="state/stateProfile.js"></script>

<script>
$.noConflict();
var _conf = conf();
angular.module('myapp', [
    'ui.router',
    'kendo.directives',
    'ui.bootstrap',
    'cropper'
], angular.noop)

.filter('reverse', function() {
    return function(items) {
        if(items) {
            return items.slice().reverse();
        } else {
            return [];
        }
    }
})

.filter('slice', function () {
    return function (inputArr, start, end) {
        var resultArr = [];

        if (!angular.isArray(inputArr)) { return inputArr; }
        if (start < 0) { start = 0; }
        if (end > inputArr.length) { end = inputArr.length; }

        for (var i = start; i < end; ++i) {
            resultArr.push(inputArr[i]);
        }
        return resultArr;
    };
})

.config(function($stateProvider, $urlRouterProvider, $httpProvider) {
    $httpProvider.interceptors.push('UserInterceptor');

    $urlRouterProvider.otherwise('schedule');  //无效路由

    $stateProvider
        .state('login', loginState)
        .state('apply', applyState)
        .state('myapply', myapplyState)
        .state('gallery', galleryState)
        .state('schedule', scheduleState)
        .state('audited', auditedState)
        .state('detail', detailState)
        .state('profile', profileState);
})

// 本地身份验证
.service('SessionService', function() {
    return {
        token: '',
        isAnonymus: true,
        session: null
    }
})

// 数据包
.service('datalump', function() {
    return {
        userList: null,
        depList: null,
        dtypeList: null,
        businessList: null
    }
})

// 暂时没用到，还有Config里也有一点相关代码
.factory('UserInterceptor', function (SessionService) {
    return {
        request: function(config) {
            if(!SessionService.isAnonymus) { 
                config.headers["x-session-token"] = SessionService.token; 
            }
            return config;
        } 
    }; 
})

.controller('customersCtrl', function($scope, $http, $state, SessionService) {
    $scope.navBar = false;
    $scope.mine = false;
    $scope.mineBar = false;
    $scope.hideNav = function () {
        $scope.navBar = !$scope.navBar;
        if($scope.mine){
            $scope.mine = !$scope.mine;
        }
    };
    $scope.hideMine = function () {
        $scope.mine = !$scope.mine;
    };
    $scope.hideMineBar = function () {
        $scope.mine = !$scope.mine;
        $scope.navBar = !$scope.navBar;
    };
    $scope.notAuditedNum = 0;
    // 本地-服务器 身份验证
     $scope.$on('$stateChangeSuccess', function(event, toState, toParams, fromState, fromParams) {
        $scope.navidx = toState.name;
        // 询问登录信息
        $http.get('api/queryauth').success(function(data) {
            if(data.loginederp) {
                SessionService.isAnonymus = false;
            } else {
                SessionService.isAnonymus = true;
            }
            SessionService.session = data;
            $scope.SessionService = SessionService; //------z

            // 广播
            $scope.$broadcast('authdone', SessionService.session.loginederp, SessionService.session.isAdmin);

            $scope.uerp = Cookie.getCookie('uerp');
            $scope.uname = decodeURI(escape(Cookie.getCookie('uname')));
            $scope.profile = $scope.uname+'('+$scope.uerp+')';

            if(SessionService.session.isAdmin) {
                $http.get('api/demand/getnotauditedcount').success(function(data) {
                    $scope.notAuditedNum = data['COUNT(*)'];
                })
            }

            // 跳登录页
            if(toState.name=='login') {
                if(SessionService.isAnonymus==false) {
                    event.preventDefault();
                    $state.go(fromState.name || 'schedule');
                    return;
                } else {
                   return;
                }
            }
            if( (toState.name=='gallery' || toState.name=='audited') && !SessionService.session.isAdmin) {
                event.preventDefault();
                $state.go(fromState.name || 'schedule');
            }
            
            // 如果是匿名游客
            if(SessionService.isAnonymus){
                event.preventDefault(); // 取消默认跳转行为
                $state.go("login");     //跳转到登录界面
            }
        }).error(function(data, status, headers, config) {
            alert('Jump to temporary 500 page');
            // location.href = 'http://www.jd.com';
        })
     });
});

/*------------------------
  页侧引导
 ------------------------*/
window.onscroll = function(event) {
    var y = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
    if(y>600) {
        document.querySelector('.mod_guid_backtop').style.display = 'block';
    } else {
        document.querySelector('.mod_guid_backtop').style.display = 'none';
    }
}
document.querySelector('.mod_guid_backtop').addEventListener('click', function() {
    var y = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop,
        i = y-50;
    window.scroll(0, i);
    var timer = setInterval(function() {
        i = i-50;
        if(i<=0) {
            window.scroll(0, 0);
            clearInterval(timer);
        } else {
            window.scroll(0, i);
        }
    }, 10)
}, false)

/*------------------------
  预加载
 ------------------------*/
;(function() {
    var res = [
            'public/img/checkbox.png',
            'public/img/checkboxdisabled.png',
            'public/img/checked.png',
            'public/img/clock.png',
            'public/img/dbusiness.png',
            'public/img/dexecutedate.png',
            'public/img/dexecutor.png',
            'public/img/dname.png',
            'public/img/dtype.png',
            'public/img/editor@2x.png',
            'public/img/favicon.ico',
            'public/img/error.png',
            // 'public/img/ico_email.png',
            // 'public/img/ico_erp.png',
            'public/img/ico_eye.png',
            'public/img/ico_eye2.png',
            // 'public/img/ico_pwd.png',
            // 'public/img/ico_triangle.png',
            'public/img/login_show.png',
            'public/img/logo.png',
            'public/img/radio.png',
            'public/img/radio_checked.png',
            'public/img/succ.png',
            'public/img/success.png',
            'public/img/white.jpg',
            'public/images/o2.jpg',
            'public/css/kendo/Material/loading.gif',
            'public/css/kendo/Material/slider-h.gif',
            'public/css/kendo/Material/slider-v.gif',
            'public/css/kendo/Material/sprite.png',
            'public/css/kendo/Material/sprite_2x.png'
        ],
        idx = 0;
    
    load();
    function load() {
        if(idx < res.length) {
            var img = new Image();
            img.src = res[idx];
            img.onload = function() {
                idx++;
                if(idx == res.length) {
                    // pageReady;
                } else {
                    load();
                }
            }
        }
    }
})();

// Cookie.setCookie('erp1.jd.com', 'BCCB7FDE7E47BAA1CC698F2D78A47636BCCED5C1B962CD58B604464F93221B5078DFB825F116D7849B12467B6CEEECB12FA9F697773F4F6FA3516CE04FA74E3BDDCF0836C31BAB8C0CC3F4F4295A97F3');
</script>
</body>
</html>